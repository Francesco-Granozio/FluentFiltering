@page "/acquisti"
@using GameStore.Application.DTOs
@using GameStore.Application.Services
@using GameStore.Domain.DTOs.Common
@using GameStore.Application.Common
@inject IAcquistoService AcquistoService
@inject NavigationManager Navigation
@inject SweetAlertService Swal

<PageTitle>Gestione Acquisti</PageTitle>

<div class="row mb-3">
    <div class="col">
        <h3>Gestione Acquisti</h3>
    </div>
    <div class="col-auto">
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add" Text="Nuovo Acquisto" Click="AggiungiAcquisto" />
    </div>
</div>

@if (errorMessage != null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Text="@errorMessage" />
}

<RadzenDataGrid @ref="grid" 
                Data="@acquisti" 
                TItem="AcquistoDto"
                AllowPaging="true" 
                AllowSorting="true"
                AllowFiltering="true"
                FilterMode="FilterMode.Advanced"
                PageSize="20"
                Count="@totalCount"
                PagerHorizontalAlign="HorizontalAlign.Left"
                ShowPagingSummary="true"
                PagingSummaryFormat="Pagina {0} di {1} ({2} elementi)"
                Loading="@isLoading"
                LoadData="@LoadData">
    
    <Columns>
        <RadzenDataGridColumn TItem="AcquistoDto" Property="UtenteUsername" Title="Utente" Width="150px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.UtenteUsername" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="GiocoTitolo" Title="Gioco" Width="200px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.GiocoTitolo" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="DataAcquisto" Title="Data Acquisto" Width="120px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.DataAcquisto.ToString("dd/MM/yyyy")" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="PrezzoPagato" Title="Prezzo Pagato" Width="120px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.PrezzoPagato.ToString("C")" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="Quantita" Title="Quantità" Width="100px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.Quantita.ToString()" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="MetodoPagamento" Title="Metodo Pagamento" Width="150px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.MetodoPagamento" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Property="CodiceSconto" Title="Codice Sconto" Width="120px">
            <Template Context="acquisto">
                <RadzenLabel Text="@acquisto.CodiceSconto" />
            </Template>
        </RadzenDataGridColumn>
        
        <RadzenDataGridColumn TItem="AcquistoDto" Filterable="false" Sortable="false" Width="120px">
            <Template Context="acquisto">
                <RadzenButton ButtonStyle="ButtonStyle.Light" 
                             Icon="edit" 
                             Size="ButtonSize.Small" 
                             Click="@(() => ModificaAcquisto(acquisto.Id))" 
                             class="me-1" />
                <RadzenButton ButtonStyle="ButtonStyle.Danger" 
                             Icon="delete" 
                             Size="ButtonSize.Small" 
                             Click="@(() => CancellaAcquisto(acquisto.Id))" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private RadzenDataGrid<AcquistoDto>? grid;
    private IEnumerable<AcquistoDto> acquisti = new List<AcquistoDto>();
    private bool isLoading = false;
    private string? errorMessage;
    private int totalCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new FilterRequest
            {
                PageNumber = 1,
                PageSize = 20,
                OrderBy = "DataCreazione desc"
            };

            var result = await AcquistoService.GetPagedAsync(request);
            if (result.IsSuccess)
            {
                acquisti = result.Value.Items;
                totalCount = result.Value.TotalItems;
                Console.WriteLine($"Loaded {acquisti.Count()} purchases, total: {totalCount}");
            }
            else
            {
                errorMessage = result.Error.Message;
                acquisti = new List<AcquistoDto>();
                totalCount = 0;
                Console.WriteLine($"Error loading purchases: {result.Error.Message}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore durante il caricamento: {ex.Message}";
            acquisti = new List<AcquistoDto>();
            totalCount = 0;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadData(LoadDataArgs args)
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new FilterRequest
            {
                PageNumber = ((args.Skip ?? 0) / (args.Top ?? 20)) + 1,
                PageSize = args.Top ?? 20,
                OrderBy = "DataCreazione desc"
            };

            var result = await AcquistoService.GetPagedAsync(request);
            if (result.IsSuccess)
            {
                acquisti = result.Value.Items;
                totalCount = result.Value.TotalItems;
            }
            else
            {
                errorMessage = result.Error.Message;
                acquisti = new List<AcquistoDto>();
                totalCount = 0;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore durante il caricamento: {ex.Message}";
            acquisti = new List<AcquistoDto>();
            totalCount = 0;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AggiungiAcquisto()
    {
        Navigation.NavigateTo("/acquisti/nuovo");
    }

    private void ModificaAcquisto(Guid id)
    {
        Navigation.NavigateTo($"/acquisti/modifica/{id}");
    }

    private async Task CancellaAcquisto(Guid id)
    {
        try
        {
            // Mostra dialog di conferma con SweetAlert2
            var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Conferma Cancellazione",
                Text = "Sei sicuro di voler cancellare questo acquisto? Questa azione non può essere annullata.",
                Icon = SweetAlertIcon.Warning,
                ShowCancelButton = true,
                ConfirmButtonText = "Sì, cancella",
                CancelButtonText = "Annulla",
                ConfirmButtonColor = "#d33",
                CancelButtonColor = "#3085d6"
            });

            if (!string.IsNullOrEmpty(result.Value))
            {
                // Mostra loading
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Cancellazione in corso...",
                    AllowOutsideClick = false,
                    AllowEscapeKey = false,
                    ShowConfirmButton = false,
                    DidOpen = new SweetAlertCallback(() => Task.CompletedTask)
                });

                var deleteResult = await AcquistoService.DeleteAsync(id);

                // Chiudi loading automaticamente
                await Swal.CloseAsync();

                if (deleteResult.IsSuccess)
                {
                    // Mostra successo
                    await Swal.FireAsync(
                        "Acquisto Cancellato",
                        "L'acquisto è stato cancellato con successo.",
                        SweetAlertIcon.Success
                    );
                    
                    // Ricarica la griglia
                    await LoadInitialData();
                }
                else
                {
                    // Mostra errore
                    await Swal.FireAsync(
                        "Errore",
                        deleteResult.Error.Message,
                        SweetAlertIcon.Error
                    );
                }
            }
        }
        catch (Exception ex)
        {
            // Chiudi loading se presente
            await Swal.CloseAsync();
            
            // Mostra errore
            await Swal.FireAsync(
                "Errore",
                $"Errore durante la cancellazione: {ex.Message}",
                SweetAlertIcon.Error
            );
        }
    }
}